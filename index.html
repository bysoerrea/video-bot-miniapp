<!DOCTYPE html>
<html>
<head>
  <title>MiniApp Video Bot</title>
  <meta charset="UTF-8">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="config.js"></script>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
                 Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    padding: 10px;
    margin: 0;
    background-color: var(--bg);
    color: var(--text);
  }
  #videoList div { margin-bottom: 10px; }
  button {
    margin: 5px;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--btn-bg);
    color: var(--btn-text);
    cursor: pointer;
  }
  input {
    padding: 6px;
    width: calc(100% - 120px);
    box-sizing: border-box;
    background: var(--input-bg);
    color: var(--input-text);
    border: 1px solid var(--border);
    border-radius: 6px;
  }
  .error { color: var(--error); font-weight: bold; }
  .loading { text-align: center; padding: 10px; }
  header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
  h1 { font-size: 18px; margin: 0; }
  @media (prefers-color-scheme: light) {
    :root {
      --bg: #ffffff; --text: #000000; --btn-bg: #ffffff; --btn-text: #000000;
      --border: #ddd; --input-bg: #ffffff; --input-text: #000000; --error: red;
    }
  }
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #121212; --text: #ffffff; --btn-bg: #1e1e1e; --btn-text: #ffffff;
      --border: #333; --input-bg: #1e1e1e; --input-text: #ffffff; --error: #ff6b6b;
    }
  }
  </style>
</head>
<body>
  <header>
    <h1>üìπ Daftar Video</h1>
  </header>

  <div>
    <input type="text" id="hashtagInput" placeholder="Filter hashtag (opsional)">
    <button id="btnSearch">üîç Cari</button>
  </div>

  <div id="videoList">‚è≥ Memuat data...</div>
  <div id="loader" class="loading" style="display:none;">‚è≥ Memuat halaman berikut...</div>

  <!-- üîΩ Player video -->
  <div style="margin-top:20px;">
    <video id="player" controls width="100%" style="max-height:360px;"></video>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (!tg) {
      document.body.innerHTML = "<h2>üö´ Akses hanya melalui Telegram App (WebApp API tidak ditemukan)</h2>";
      throw new Error("Blocked: Telegram WebApp JS not available");
    }
    tg.ready();

    const ua = (navigator.userAgent || "").toLowerCase();
    if (!ua.includes("telegram")) {
      document.body.innerHTML = "<h2>üö´ Akses gagal ‚Äî buka halaman ini melalui aplikasi Telegram di ponsel.</h2>";
      throw new Error("Blocked: Not Telegram App");
    }

    let currentPage = 1;
    let totalPages = 1;
    let currentHashtag = "";
    let isLoading = false;

    document.getElementById("btnSearch").addEventListener("click", applyFilter);

    function showError(msg) {
      document.getElementById("videoList").innerHTML = `<div class="error">‚ùå ${msg}</div>`;
    }

    function loadVideos(append = false) {
      if (isLoading) return;
      isLoading = true;

      if (!append) {
        document.getElementById("videoList").innerHTML = "‚è≥ Memuat...";
      } else {
        document.getElementById("loader").style.display = "block";
      }

      const initData = tg.initData || "";
      if (!initData) {
        showError("Init data Telegram tidak ditemukan. Pastikan membuka melalui tombol MiniApp di Telegram.");
        isLoading = false;
        document.getElementById("loader").style.display = "none";
        return;
      }

      const url = `${BASE_URL}?action=getvideos&page=${currentPage}&limit=10&hashtag=${encodeURIComponent(currentHashtag)}&initData=${encodeURIComponent(initData)}`;

      fetch(url, { credentials: "omit" })
        .then(res => res.text())
        .then(txt => {
          let data;
          try { data = JSON.parse(txt); }
          catch (e) { showError("JSON Parse Error: " + e.message); console.error(e, txt); return; }

          if (!data.success) {
            showError(data.error || "Error dari server");
            return;
          }

          totalPages = data.totalPages || 1;
          if (!append) document.getElementById("videoList").innerHTML = "";

          if (data.data.length === 0 && currentPage === 1) {
            document.getElementById("videoList").innerHTML = "üòî Tidak ada video ditemukan.";
            return;
          }

          const listHTML = data.data.map(v => {
            const cap = escapeHtml(v.caption || '(tanpa caption)');
            const uid = escapeHtml(v.uniqueId || v.file_unique_id || '');
            const fid = escapeHtml(v.file_id || v.fileId || '');
            return `<div>
              üé¨ ${cap}<br>
              <small>üîî ${uid}</small><br>
              <button onclick="playVideo('${fid}')">‚ñ∂Ô∏è Play</button>
            </div>`;
          }).join("<hr>");

          document.getElementById("videoList").insertAdjacentHTML("beforeend", listHTML);
        })
        .catch(err => { showError("Fetch Error: " + err.message); console.error(err); })
        .finally(() => { isLoading = false; document.getElementById("loader").style.display = "none"; });
    }

    function applyFilter() {
      currentHashtag = document.getElementById("hashtagInput").value.trim();
      currentPage = 1;
      loadVideos(false);
    }

    window.addEventListener("scroll", () => {
      if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 120) {
        if (currentPage < totalPages && !isLoading) {
          currentPage++;
          loadVideos(true);
        }
      }
    });

    function escapeHtml(s) {
      if (!s) return '';
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // üîπ Fungsi Play Video (panggil endpoint GAS getfileurl)
    function playVideo(fileId) {
      if (!fileId) return alert("FileId kosong");
      const initData = tg.initData || "";
      fetch(`${BASE_URL}?action=getfileurl&file_id=${encodeURIComponent(fileId)}&initData=${encodeURIComponent(initData)}`)
        .then(res => res.json())
        .then(data => {
          if (!data.url) return alert("Gagal ambil URL video");
          const player = document.getElementById('player');
          player.src = data.url;
          player.poster = data.thumbnail || "";
          player.play();
        })
        .catch(err => alert("Error: " + err.message));
    }

    loadVideos(false);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>MiniApp Video Bot</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Pastikan config.js mendefinisikan: window.BASE_URL -->
  <script src="config.js"></script>
  <style>
    :root { --radius: 8px; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 12px;
      background: var(--bg); color: var(--text);
    }
    header { margin-bottom: 10px; }
    h1 { font-size: 18px; margin: 0 0 8px; }
    .toolbar { display: flex; gap: 8px; align-items: center; }
    input[type="text"] {
      flex: 1; padding: 8px 10px; border-radius: 6px;
      border: 1px solid var(--border); background: var(--input-bg); color: var(--input-text);
    }
    button {
      padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border);
      background: var(--btn-bg); color: var(--btn-text); cursor: pointer;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .error { color: var(--error); margin-top: 8px; }
    .loading { text-align: center; padding: 10px; opacity: 0.8; }
    #videoList { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
    .item {
      border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--card-bg);
    }
    .media { aspect-ratio: 16 / 9; background: #000; position: relative; }
    .thumb { width: 100%; height: 100%; object-fit: cover; display: block; }
    .placeholder { display:flex; align-items:center; justify-content:center; color:#888; font-size:48px; height:100%; }
    .badge {
      position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.5); color:#fff;
      padding:2px 6px; border-radius: 999px; font-size:12px;
    }
    .meta { padding: 10px; }
    .cap { margin-bottom: 6px; }
    .uid { opacity: 0.8; font-size: 12px; }
    .row { margin-top: 8px; display:flex; justify-content:flex-end; gap: 8px; align-items: center; }
    .chip { font-size: 12px; opacity: 0.85; }
    video { width: 100%; height: 100%; display: block; background: #000; }
    @media (prefers-color-scheme: light) {
      :root { --bg:#fff; --text:#0b0b0b; --border:#ddd; --btn-bg:#fff; --btn-text:#0b0b0b; --input-bg:#fff; --input-text:#0b0b0b; --error:#d32f2f; --card-bg:#fff; }
    }
    @media (prefers-color-scheme: dark) {
      :root { --bg:#111; --text:#f5f5f5; --border:#2b2b2b; --btn-bg:#1d1d1d; --btn-text:#f5f5f5; --input-bg:#1a1a1a; --input-text:#f5f5f5; --error:#ff6b6b; --card-bg:#161616; }
    }
  </style>
</head>
<body>
  <header>
    <h1>üìπ Daftar Video</h1>
    <div class="toolbar">
      <input type="text" id="hashtagInput" placeholder="Filter hashtag (opsional)" />
      <button id="btnSearch">üîç Cari</button>
    </div>
    <div id="topError" class="error" style="display:none;"></div>
  </header>

  <div id="videoList">‚è≥ Memuat data...</div>
  <div id="loader" class="loading" style="display:none;">‚è≥ Memuat halaman berikut...</div>

  <script>
    // ====== Telegram context guard ======
    const tg = window.Telegram?.WebApp;
    if (!tg) {
      document.body.innerHTML = "<h2 style='padding:16px;'>üö´ Halaman ini harus dibuka dari Telegram Mini App.</h2>";
      throw new Error("Telegram WebApp not found");
    }
    tg.ready();

    // ====== State ======
    let currentPage = 1;
    let totalPages = 1;
    let currentHashtag = "";
    let isLoading = false;
    const seenIds = new Set();
    let currentPlayingItem = null;

    // ====== Elements ======
    const videoList = document.getElementById("videoList");
    const loader = document.getElementById("loader");
    const btnSearch = document.getElementById("btnSearch");
    const inputHashtag = document.getElementById("hashtagInput");
    const topError = document.getElementById("topError");

    btnSearch.addEventListener("click", applyFilter);
    inputHashtag.addEventListener("keydown", (e) => {
      if (e.key === "Enter") applyFilter();
    });

    // ====== Utils ======
    function escapeHtml(s) {
      if (!s) return "";
      return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function fmtCaption(s) {
      const cap = s || "(tanpa caption)";
      return escapeHtml(cap);
    }
    function previewHTML(thumb) {
      if (thumb) {
        return `<img class="thumb" src="${escapeHtml(thumb)}" alt="thumbnail" loading="lazy">`;
      }
      return `<div class="placeholder">üé¨</div>`;
    }

    function itemHTML(v) {
      const cap = fmtCaption(v.caption);
      const uid = escapeHtml(v.uniqueId || v.file_unique_id || "");
      const fid = escapeHtml(v.file_id || v.fileId || "");
      // PATCH: Fallback thumbnail dari ThumbFileId via getfileurl
      let thumbUrl = v.thumbnail || "";
      if (!thumbUrl && v.ThumbFileId) {
        const initData = tg.initData || "";
        thumbUrl = `${BASE_URL}?action=getfileurl&file_id=${encodeURIComponent(v.ThumbFileId)}&initData=${encodeURIComponent(initData)}`;
      }
      const thumb = escapeHtml(thumbUrl);
      return `
        <div class="item" data-fid="${fid}" data-uid="${uid}" data-cap="${cap}" data-thumb="${thumb}">
          <div class="media">
            ${previewHTML(thumb)}
            <span class="badge">UID</span>
          </div>
          <div class="meta">
            <div class="cap">üé¨ ${cap}</div>
            <div class="uid">üîî ${uid}</div>
            <div class="row">
              <span class="chip">Ready</span>
              <button class="btn-play">‚ñ∂Ô∏è Play</button>
            </div>
          </div>
        </div>
      `;
    }

    function setLoading(append) {
      if (!append) {
        videoList.innerHTML = "‚è≥ Memuat...";
      } else {
        loader.style.display = "block";
      }
    }
    function clearLoading() {
      isLoading = false;
      loader.style.display = "none";
    }
    function renderError(msg) {
      topError.textContent = msg;
      topError.style.display = "block";
      setTimeout(() => { topError.style.display = "none"; }, 4000);
    }

    // ====== Data fetch & render ======
    function loadVideos(append = false) {
      if (isLoading) return;
      isLoading = true;
      setLoading(append);

      const initData = tg.initData || "";
      if (!initData) {
        videoList.innerHTML = `<div class="error">‚ùå Init data Telegram tidak ditemukan. Buka lewat Mini App.</div>`;
        clearLoading();
        return;
      }

      const url = `${BASE_URL}?action=getvideos&page=${currentPage}&limit=10&hashtag=${encodeURIComponent(currentHashtag)}&initData=${encodeURIComponent(initData)}`;
      fetch(url)
        .then(res => res.text())
        .then(txt => {
          let data;
          try { data = JSON.parse(txt); }
          catch (e) {
            videoList.innerHTML = `<div class="error">‚ùå Respon server bukan JSON valid.</div>`;
            return;
          }
          if (!data.success) {
            videoList.innerHTML = `<div class="error">‚ùå ${escapeHtml(data.error || "Error server")}</div>`;
            return;
          }
          totalPages = data.totalPages || 1;

          if (!append) videoList.innerHTML = "";

          const items = Array.isArray(data.data) ? data.data : [];
          const html = [];
          for (const v of items) {
            const uid = v.uniqueId || v.file_unique_id || "";
            if (uid && seenIds.has(uid)) continue;
            if (uid) seenIds.add(uid);
            html.push(itemHTML(v));
          }

          if (html.length === 0 && currentPage === 1 && seenIds.size === 0) {
            videoList.innerHTML = "üòî Tidak ada video.";
            return;
          }
          if (html.length > 0) {
            videoList.insertAdjacentHTML("beforeend", html.join(""));
          }
        })
        .catch(err => {
          videoList.innerHTML = `<div class="error">‚ùå ${escapeHtml(err.message || "Gagal memuat")}</div>`;
        })
        .finally(clearLoading);
    }

    function applyFilter() {
      currentHashtag = inputHashtag.value.trim();
      currentPage = 1;
      totalPages = 1;
      seenIds.clear();
      stopCurrentPlaying();
      loadVideos(false);
    }

    // Infinite scroll
    window.addEventListener("scroll", () => {
      if (isLoading) return;
      const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 120);
      if (nearBottom && currentPage < totalPages) {
        currentPage++;
        loadVideos(true);
      }
    });

    // ====== Inline player ======
    videoList.addEventListener("click", (e) => {
      const btn = e.target.closest(".btn-play");
      if (!btn) return;
      const item = btn.closest(".item");
      const fid = item?.dataset?.fid;
      if (!fid) {
        renderError("file_id tidak tersedia.");
        return;
      }
      if (item.classList.contains("is-playing")) {
        stopItem(item);
        return;
      }
      playInline(item, fid);
    });

    function stopCurrentPlaying() {
      if (!currentPlayingItem) return;
      stopItem(currentPlayingItem);
      currentPlayingItem = null;
    }

    function stopItem(item) {
      item.classList.remove("is-playing");
      const media = item.querySelector(".media");
      media.innerHTML = `${previewHTML(item.dataset.thumb)}<span class="badge">UID</span>`;
      const chip = item.querySelector(".chip");
      if (chip) chip.textContent = "Ready";
      const btn = item.querySelector(".btn-play");
      if (btn) btn.textContent = "‚ñ∂Ô∏è Play";
    }

    async function resolveFileUrl(fid) {
      const initData = tg.initData || "";
      const url = `${BASE_URL}?action=getfileurl&file_id=${encodeURIComponent(fid)}&initData=${encodeURIComponent(initData)}`;
      const text = await (await fetch(url)).text();
      // Terima JSON { success, url } atau langsung string URL
      try {
        const obj = JSON.parse(text);
        if (obj && obj.url) return obj.url;
        throw new Error("Respon JSON tanpa url");
      } catch {
        // Fallback: jika text sudah berupa URL
        if (/^https?:\/\//i.test(text.trim())) return text.trim();
        throw new Error("Respon getfileurl tidak valid");
      }
    }

    async function playInline(item, fid) {
      try {
        btnSearch.disabled = true;

        // Stop player lain
        stopCurrentPlaying();

        const media = item.querySelector(".media");
        const chip = item.querySelector(".chip");
        const btn = item.querySelector(".btn-play");
        if (chip) chip.textContent = "Loading...";
        if (btn) btn.textContent = "‚è≥";

        // Dapatkan direct file URL (signed)
        const fileUrl = await resolveFileUrl(fid);

        // Build <video>
        const poster = item.dataset.thumb || "";
        const videoEl = document.createElement("video");
        videoEl.setAttribute("playsinline", "");
        videoEl.setAttribute("preload", "metadata");
        videoEl.controls = true;
        videoEl.src = fileUrl;
        if (poster) videoEl.poster = poster;

        // Swap UI
        item.classList.add("is-playing");
        media.innerHTML = "";
        media.appendChild(videoEl);
        if (chip) chip.textContent = "Playing";
        if (btn) btn.textContent = "‚èπ Stop";

        // Auto play (best effort)
        const playPromise = videoEl.play();
        if (playPromise && typeof playPromise.then === "function") {
          playPromise.catch(() => {/* ignore autoplay block */});
        }

        // Events
        videoEl.addEventListener("ended", () => stopItem(item));
        videoEl.addEventListener("error", () => {
          renderError("Gagal memutar video.");
          stopItem(item);
        });

        // Mark current
        currentPlayingItem = item;
      } catch (err) {
        renderError(err.message || "Tidak bisa memuat video.");
        stopItem(item);
      } finally {
        btnSearch.disabled = false;
      }
    }

    // ====== Boot ======
    loadVideos(false);
  </script>
</body>
</html>
